---
import type { GalleryImage } from '../config/gallery';

export interface Props {
  images: GalleryImage[];
}

const { images } = Astro.props;
---

<div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
  {images.map((img) => (
    <figure class="group relative overflow-hidden rounded-2xl border-4 border-white bg-slate-100 shadow-lg transition-transform hover:-translate-y-1 hover:shadow-xl">
      <div class="aspect-[4/3] w-full overflow-hidden">
        <img
          src={img.src}
          alt={img.alt}
          loading="lazy"
          decoding="async"
          class="h-full w-full object-contain transition-transform duration-500 group-hover:scale-110 cursor-zoom-in gallery-trigger"
          data-full-src={img.src}
        />
      </div>
      <div class="absolute inset-0 bg-black/0 transition-colors group-hover:bg-black/10 pointer-events-none"></div>
    </figure>
  ))}
</div>

<!-- Modal de Visualização -->
<div id="gallery-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/95 backdrop-blur-sm opacity-0 transition-opacity duration-300 h-[100dvh] w-screen" role="dialog" aria-modal="true">
  <button id="close-modal" class="absolute top-4 right-4 z-50 rounded-full bg-white/10 p-3 text-white hover:bg-white/20 hover:text-sonic-gold transition-all focus:outline-none focus:ring-2 focus:ring-sonic-gold" aria-label="Fechar galeria">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </button>
  
  <div class="relative w-full h-full flex items-center justify-center pointer-events-none p-4 sm:p-8">
    <img 
      id="modal-image" 
      src="" 
      alt="Visualização em tamanho real" 
      class="pointer-events-auto max-w-full max-h-[85dvh] rounded-lg object-contain shadow-2xl scale-95 transition-transform duration-300 select-none"
      onerror="this.onerror=null; this.src='/images/placeholder.jpg'; this.alt='Imagem não disponível';" 
    />
    <div id="modal-loader" class="absolute inset-0 flex items-center justify-center pointer-events-none">
       <div class="h-12 w-12 animate-spin rounded-full border-4 border-sonic-gold border-t-transparent"></div>
    </div>
  </div>
</div>

<script>
  // Script para controle do Modal
  const modal = document.getElementById('gallery-modal');
  const modalImg = document.getElementById('modal-image') as HTMLImageElement;
  const loader = document.getElementById('modal-loader');
  const closeBtn = document.getElementById('close-modal');
  const triggers = document.querySelectorAll('.gallery-trigger');

  function openModal(src: string) {
    if (!modal || !modalImg || !loader) return;
    
    // Reset state
    modal.classList.remove('hidden');
    // Force reflow for transition
    requestAnimationFrame(() => {
      modal.classList.remove('opacity-0');
      modalImg.classList.remove('scale-95');
      modalImg.classList.add('scale-100');
    });
    
    loader.style.display = 'flex';
    modalImg.style.opacity = '0.5';

    // Load image
    const newImg = new Image();
    newImg.src = src;
    newImg.onload = () => {
      modalImg.src = src;
      loader.style.display = 'none';
      modalImg.style.opacity = '1';
    };
    
    document.body.style.overflow = 'hidden'; // Prevent scrolling
  }

  function closeModal() {
    if (!modal || !modalImg) return;
    
    modal.classList.add('opacity-0');
    modalImg.classList.remove('scale-100');
    modalImg.classList.add('scale-95');
    
    setTimeout(() => {
      modal.classList.add('hidden');
      modalImg.src = ''; // Clear src
      document.body.style.overflow = '';
    }, 300);
  }

  // Event Listeners
  triggers.forEach(trigger => {
    trigger.addEventListener('click', (e) => {
      const target = e.target as HTMLImageElement;
      const src = target.dataset.fullSrc || target.src;
      openModal(src);
    });
  });

  closeBtn?.addEventListener('click', closeModal);

  // Close on background click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
      closeModal();
    }
  });
</script>

